# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from io import BytesIO
import numpy as np


def read_bundle_cameras(path):
    """Reads cameras from a bundle file (format:
    https://github.com/snavely/bundler_sfm#output-format).
    """
    with open(path, 'r') as h:
        lines = list(h)
    lines = [x.rstrip() for x in lines]

    n_cam, n_points = lines[1].split(' ')
    n_cam, n_points = int(n_cam), int(n_points)

    cams = []
    for i in range(n_cam):
        f_k1_k2 = lines[2 + 5 * i]
        rot_row1 = lines[2 + 5 * i + 1]
        rot_row2 = lines[2 + 5 * i + 2]
        rot_row3 = lines[2 + 5 * i + 3]
        trans = lines[2 + 5 * i + 4]

        f = float(f_k1_k2.split(' ')[0])
        from IPython import embed; embed()


def save_npz(dict_, path):
    """The extra hassle is for Google infra.
    """
    with open(path, 'wb') as h:
        io_buffer = BytesIO()
        np.savez(io_buffer, **dict_)
        h.write(io_buffer.getvalue())
